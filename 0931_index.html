<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ontong Daejeon</title>
  <style>
    :root{
      --brand:#FF8215; --brand-600:#D96500; --brand-700:#BC5800;
      --bg:#f8f9fa; --ink:#111; --muted:#565D6D;
      --surface:#ffffff; --surface-2:#FFEAD8; --line:#e9ecef;
      --panel:#ffffff; --panel-line:#e9ecef;
      --btn-text:#fff; --input-bg: rgba(255,255,255,.78); --input-border: var(--brand);
      --shadow-sm:0 1px 2.5px rgba(23,26,31,.07), 0 0 2px rgba(23,26,31,.08);
      --ring:0 0 0 3px rgba(255,130,21,.25);
      --header-height:64px;
      --footer-min-height:180px;
    }
    .theme-dark{
      --bg:#0b0c0f; --ink:#eaecef; --muted:#9aa4b2;
      --surface:#121418; --surface-2:#2a2f36; --line:#1f232a;
      --panel:#111318; --panel-line:#20242b;
      --btn-text:#fff; --input-bg: rgba(23,26,31,.72); --input-border:#ff9a4a;
      --shadow-sm:0 6px 24px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      color:var(--ink); background:var(--bg);
      display:flex; flex-direction:column; min-height:100vh;
    }
    .topbar{ position:sticky; top:0; z-index:1000; width:100%;
      background:var(--surface-2);
      box-shadow: 0 0 1px rgba(23,26,31,.25), 0 2px 12px rgba(23,26,31,.08); }
    .topbar__inner{ max-width:1200px; margin:0 auto; padding:10px 12px;
      display:flex; align-items:center; gap:12px; min-height:var(--header-height); }
    .panel-toggle{ appearance:none; border:1px solid var(--line); background:#0000; color:var(--ink);
      border-radius:8px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow-sm); }
    .panel-toggle:hover{ background:rgba(0,0,0,.06); }
    .image{ width:32px; height:32px; border-radius:8px; object-fit:cover; cursor:pointer; }
    .topbar .text{ font-family:"Borel", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      font-size:25px; font-weight:700; color:var(--brand); white-space:nowrap; cursor:pointer; }
    .header-menu{ display:flex; align-items:center; gap:8px; margin-left:8px; }
    .header-menu .header-menu-item{
      padding:4px 12px; display:flex; align-items:center; justify-content:center;
      color:var(--ink); background:transparent; border:1px solid var(--line); border-radius:6px;
      cursor:pointer; white-space:nowrap; text-decoration:none;
      transition:background .2s ease, color .2s ease, border-color .2s ease;
    }
    .header-menu .header-menu-item:hover{ background:rgba(0,0,0,.05); }
    .header-menu .header-menu-item--primary{ color:var(--brand); border-color:var(--brand); }
    .textbox{ position:relative; display:flex; align-items:center; gap:8px; margin-left:auto;
      padding:4px 6px; border-radius:12px; background:var(--input-bg); box-shadow:var(--shadow-sm); }
    .textbox input{
      width:min(42vw, 280px); height:40px; padding: 6px 12px;
      color:var(--ink); border:1px solid var(--input-border); border-radius:8px; background:#fff; outline:none; }
    .theme-dark .textbox{ background:var(--input-bg); box-shadow:none; }
    .theme-dark .textbox input{ background:rgba(15,17,22,.85); color:var(--ink); border-color:var(--input-border); }
    .btn-search{
      height:40px; padding:0 14px; border:none; border-radius:8px; background:var(--brand); color:var(--btn-text);
      cursor:pointer; box-shadow:var(--shadow-sm); display:inline-flex; align-items:center; gap:8px; font-weight:600;
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease; position:relative; overflow:hidden; }
    .btn-search:hover{ background:var(--brand-600); }
    .btn-search:active{ transform: translateY(1px); background:var(--brand-700); }
    .btn-search::after{ content:""; position:absolute; inset:auto; width:0; height:0; border-radius:999px;
      background:rgba(255,255,255,.35); transform:translate(-50%,-50%); pointer-events:none; opacity:0; }
    .btn-search.ripple::after{ animation: ripple .5s ease; }
    @keyframes ripple{ 0%{ width:0; height:0; opacity:.5; } 100%{ width:220px; height:220px; opacity:0; } }
    .theme-toggle{ appearance:none; border:1px solid var(--line); background:transparent; color:var(--ink);
      border-radius:8px; padding:8px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .theme-toggle:hover{ background:rgba(0,0,0,.06); }

    .category-bar{ background:var(--surface); box-shadow:0 1px 0 rgba(23,26,31,.08); }
    .category-bar__inner{ max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:12px; align-items:center; }
    .category-bar__title{ font-size:13px; color:var(--muted); font-weight:600; white-space:nowrap; }
    .category-scroll{ display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; }
    .category-scroll::-webkit-scrollbar{ height:6px; }
    .category-scroll::-webkit-scrollbar-thumb{ background:rgba(23,26,31,.18); border-radius:999px; }
    .category-button{ appearance:none; border:1px solid rgba(23,26,31,.1); background:rgba(255,255,255,.9); color:var(--ink);
      border-radius:999px; padding:6px 14px; font-size:13px; cursor:pointer; white-space:nowrap; transition:background .2s ease, box-shadow .2s ease, transform .1s ease; }
    .category-button:hover{ background:#fff; box-shadow:0 2px 8px rgba(23,26,31,.08); }
    .category-button:active{ transform:translateY(1px); }
    .theme-dark .category-bar{ background:var(--surface-2); box-shadow:0 1px 0 rgba(0,0,0,.35); }
    .theme-dark .category-button{ background:rgba(26,29,36,.9); border-color:rgba(255,255,255,.08); color:var(--ink); }

    .layout{ width:100%; max-width:1200px; margin:0 auto; flex:1 1 auto; min-height:0; height:100%;
      display:grid; grid-template-columns: minmax(0, 1fr); grid-auto-rows:minmax(0,1fr); gap:16px; padding:16px; }
    .layout.panel-open{ grid-template-columns: 340px minmax(0, 1fr); }

    .sidepanel{ background:var(--panel); border:1px solid var(--panel-line); border-radius:12px; overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.05); display:none; flex-direction:column; }
    .layout.panel-open .sidepanel, .sidepanel.open{ display:flex; }
    .tabs{ display:flex; border-bottom:1px solid var(--panel-line); }
    .tab{ flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:600; }
    .tab.active{ color:var(--brand); border-bottom:2px solid var(--brand); }
    .sidepanel__head{ padding:12px; border-bottom:1px solid var(--panel-line); display:grid; gap:8px; }
    .field{ display:grid; gap:6px; }
    .label{ font-size:12px; color:var(--muted); }
    .select, .input{ height:36px; padding:6px 10px; border:1px solid var(--panel-line); border-radius:8px;
      background:var(--surface); color:var(--ink); }
    .sidepanel__actions{ display:flex; gap:8px; }
    .btn-outline{ background:transparent; color:var(--ink); border:1px solid var(--panel-line); border-radius:8px; height:36px; padding:0 10px; cursor:pointer;}
    .btn-fill{ background:var(--brand); color:#fff; border:0; border-radius:8px; height:36px; padding:0 12px; cursor:pointer;}
    .btn-fill:hover{ background:var(--brand-600); }

    .panel-sections{ display:grid; gap:12px; padding:12px; border-bottom:1px solid var(--panel-line); max-height:220px; overflow:auto; }
    .section-title{ font-weight:700; font-size:13px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; }
    .list-plain{ list-style:none; margin:0; padding:0; }
    .recent-list{ list-style:none; margin:0; padding:0; display:grid; gap:6px; }
    .recent-item{ border:1px solid var(--panel-line); border-radius:10px; padding:6px 8px; background:var(--surface); display:grid; gap:6px; }
    .recent-row{ display:flex; gap:8px; align-items:flex-start; }
    .recent-tag{ font-size:12px; font-weight:600; color:var(--brand); background:rgba(255,130,21,.08); border-radius:6px; padding:2px 6px; }
    .recent-text{ flex:1; font-size:13px; line-height:1.5; max-height:1.5em; overflow:hidden; position:relative; }
    .recent-text[data-expanded="true"]{ max-height:none; }
    .recent-more{ border:none; background:transparent; color:var(--brand); cursor:pointer; font-size:12px; font-weight:600; align-self:flex-start; }
    .recent-rerun{ border:none; background:var(--brand); color:#fff; border-radius:6px; padding:4px 8px; font-size:12px; cursor:pointer; box-shadow:var(--shadow-sm); }
    .recent-rerun:hover{ background:var(--brand-600); }
    .recent-empty{ font-size:12px; color:var(--muted); padding:8px 6px; }
    .chip{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px solid var(--panel-line); border-radius:999px; background:var(--surface); margin:4px 4px 0 0; }
    .chip button{ border:none; background:transparent; cursor:pointer; color:var(--muted); }
    .clear-btn{ border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:12px; }
    .sidepanel__body{ overflow:auto; }
    .results{ list-style:none; padding:0; margin:0; }
    .result-item{ padding:10px 12px; border-bottom:1px solid var(--panel-line); display:grid; gap:4px; }
    .result-item:hover{ background:#fafafa; }
    .result-row{ display:flex; justify-content:space-between; gap:8px; }
    .result-title{ font-weight:700; font-size:14px; margin:0; }
    .result-title span{ vertical-align:middle; }
    .result-addr{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .result-tags{ display:flex; gap:6px; margin-top:4px; flex-wrap:wrap; }
    .pill{ font-size:11px; border-radius:999px; padding:2px 8px; border:1px solid #ffd1b0; color:#c05621; background:#fff7f0; }
    .theme-dark .pill{ border-color:#54402f; color:#ffb370; background:#2b241e; }

    .fav-btn{ border:none; background:transparent; cursor:pointer; font-size:16px; line-height:1; }
    .fav-btn.active{ color:#ffb703; }

    .sidepanel__foot{ padding:8px 12px; border-top:1px solid var(--panel-line); display:flex; justify-content:space-between; align-items:center; }
    .pager{ display:flex; gap:8px; }
    .pager button{ height:30px; padding:0 10px; border:1px solid var(--panel-line); border-radius:8px; background:var(--surface); color:var(--ink); cursor:pointer; }
    .pager button:disabled{ opacity:.5; cursor:not-allowed; }

    .map-wrap{ border-radius:12px; background:#e9ecef; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.06);
      position:relative; min-height:320px; height:100%; }
    #map{ width:100%; height:100%; min-height:100%; }

    .status-indicator{ display:inline-flex; align-items:center; justify-content:center; width:10px; height:10px; border-radius:50%; margin-right:6px; box-shadow:0 0 0 2px rgba(255,255,255,.7); }
    .status-indicator--pending{ background:#ffd166; }
    .status-indicator--ok{ background:#2ecc71; }
    .status-indicator--none{ background:#ef476f; }
    .status-overlay{ display:flex; align-items:center; justify-content:center; width:14px; height:14px; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.25); background:#ffd166; }
    .status-overlay.status-ok{ background:#2ecc71; }
    .status-overlay.status-none{ background:#ef476f; }

    .rectangle{ background:var(--surface-2); margin-top:auto; box-shadow:0 -1px 0 rgba(23,26,31,.06) inset; }
    .rectangle__inner{ max-width:1200px; margin:0 auto; padding:24px 16px; }
    .rectangle .text{ font-size:16px; color:#FFCB9D; margin:0 0 12px; }
    .theme-dark .rectangle .text{ color:#ffbb86; }
    .line{ width:100%; height:1px; background: var(--brand); opacity:.7; border:0; margin:8px 0 14px; }
    .rectangle__bar{ display:flex; justify-content:space-between; gap:12px; font-size:12px; color:var(--muted); }

    @media (prefers-color-scheme: dark) { #logoIcon {
        content: url("https://raw.githubusercontent.com/AKCU-ryu/OntongDaejeon/main/public/img/logo_bow.png");}} /* 다크모드 전용 로고 */
    @media (prefers-color-scheme: light) { #logoIcon {
        content: url("https://raw.githubusercontent.com/AKCU-ryu/OntongDaejeon/main/public/img/logo_bob.png");}} /* 기본 로고 */
    @media (max-width: 920px){
      .header-menu{ display:none; }
      .layout{ grid-template-columns: 1fr; }
      .layout.panel-open{ grid-template-columns: 1fr; }
      .sidepanel{
        display:flex;
        position: fixed; inset: 64px 0 0 auto; width: min(92vw, 370px);
        transform: translateX(-100%); left:0; right:auto;
        transition: transform .25s ease; z-index: 900;
        visibility:hidden;
      }
      .sidepanel.open{ transform: translateX(0); visibility:visible; }
      .backdrop{ position: fixed; inset:0; background: rgba(0,0,0,.25); opacity:0; pointer-events:none; transition: opacity .2s ease; z-index: 890; }
      .backdrop.show{ opacity:1; pointer-events:auto; }
      .panel-toggle{ display:inline-flex; }
      .textbox{ width:100%; }
      .textbox input{ flex:1; width:auto; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar__inner">
      <button class="panel-toggle" id="togglePanel" aria-label="좌측 패널 열기">☰</button>
      <img class="image" id="logoIcon" src="https://raw.githubusercontent.com/AKCU-ryu/OntongDaejeon/main/public/img/logo_bow.png" alt="Ontong 로고">
      <div class="text" id="logoText">Ontong Daejeon</div>
      <nav class="header-menu">
        <a class="header-menu-item header-menu-item--primary" href="index.html">홈</a>
        <a class="header-menu-item" href="service.html" target="_blank" rel="noopener noreferrer">서비스</a>
        <a class="header-menu-item" href="how-to.html" target="_blank" rel="noopener noreferrer">이용방법</a>
        <a class="header-menu-item" href="qna.html" target="_blank" rel="noopener noreferrer">문의</a>
      </nav>
      <div class="textbox" role="search">
        <input id="q" type="search" placeholder="지역·주소·키워드 (예: 대전 카페)" aria-label="검색어 입력">
        <button class="btn-search" id="searchBtn" aria-label="검색" title="검색">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"></circle>
            <path d="M20 20L17 17" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"></path>
          </svg>
          검색
        </button>
      </div>
      <button class="theme-toggle" id="themeToggle" aria-label="다크 모드 토글" title="다크 모드">🌙</button>
    </div>
  </header>
  <div class="backdrop" id="backdrop" hidden></div>
  <div class="category-bar">
    <div class="category-bar__inner">
      <div class="category-bar__title">카테고리 바로가기</div>
      <div class="category-scroll" id="categoryTags" aria-label="카카오 카테고리"></div>
    </div>
  </div>
  <div class="layout" id="layout">
    <aside class="sidepanel" id="panel" aria-label="검색 패널">
      <div class="tabs">
        <div class="tab active" id="tabKakao">카카오 장소</div>
        <div class="tab" id="tabOD">온통대전 가맹점</div>
      </div>

      <div class="sidepanel__head" id="headKakao">
        <div class="field">
          <label class="label" for="cat">카테고리</label>
          <select class="select" id="cat">
              <option value="">전체</option>
              <option value="MT1">대형마트</option>
              <option value="CS2">편의점</option>
              <option value="PS3">어린이집/유치원</option>
              <option value="SC4">학교</option>
              <option value="AC5">학원</option>
              <option value="PK6">주차장</option>
              <option value="OL7">주유소/충전소</option>
              <option value="SW8">지하철역</option>
              <option value="BK9">은행</option>
              <option value="CT1">문화시설</option>
              <option value="AG2">중개업소</option>
              <option value="PO3">공공기관</option>
              <option value="AT4">관광명소</option>
              <option value="AD5">숙박</option>
              <option value="FD6">음식점</option>
              <option value="CE7">카페</option>
              <option value="HP8">병원</option>
              <option value="PM9">약국</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="radius">반경 (m)</label>
          <select class="select" id="radius">
            <option value="1000">1,000</option>
            <option value="2000" selected>2,000</option>
            <option value="3000">3,000</option>
            <option value="5000">5,000</option>
          </select>
        </div>
      </div>

      <div class="sidepanel__head" id="headOD" style="display:none;">
        <div class="field">
          <label class="label" for="odName">가맹점</label>
          <input class="input" id="odName" placeholder="예: 스미스비어">
        </div>
        <div class="field">
          <label class="label" for="odAddr">주소</label>
          <input class="input" id="odAddr" placeholder="예: 둔산대로 157">
        </div>
        <div class="field">
          <label class="label" for="odGu">구</label>
          <input class="input" id="odGu" placeholder="예: 서구">
        </div>
        <div class="field">
          <label class="label" for="odDong">동</label>
          <input class="input" id="odDong" placeholder="예: 둔산동">
        </div>
        <div class="sidepanel__actions">
          <button id="btnODSearch" class="btn-fill" type="button">가맹점 검색</button>
          <button id="btnODReset" class="btn-outline" type="button">초기화</button>
        </div>
      </div>

      <div class="panel-sections">
        <div class="section-title">
          <span>최근 검색</span>
          <button class="clear-btn" id="btnClearRecents" title="최근 검색 비우기">지우기</button>
        </div>
        <ul class="recent-list" id="recentList" aria-live="polite"></ul>

        <div class="section-title" style="margin-top:4px;">
          <span>즐겨찾기</span>
          <button class="clear-btn" id="btnClearFavs" title="즐겨찾기 모두 해제">지우기</button>
        </div>
        <ul class="list-plain" id="favList"></ul>
      </div>

      <div class="sidepanel__body">
        <ul class="results" id="results"></ul>
      </div>

      <div class="sidepanel__foot">
        <div class="pager">
          <button id="prevPage" type="button">이전</button>
          <button id="nextPage" type="button">다음</button>
        </div>
        <div class="muted" id="pageInfo"></div>
      </div>
    </aside>
    <section class="map-wrap">
      <div id="map"></div>
    </section>
  </div>

  <footer class="rectangle">
    <div class="rectangle__inner">
      <p class="text">대전 지역 정보를 쉽고 빠르게.</p>
      <div class="line"></div>
      <div class="rectangle__bar">
        <span>© 2025 Ontong Daejeon. All rights reserved.</span>
        <span>Made with ♥ in Daejeon</span>
      </div>
    </div>
  </footer>

  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7bdd6f8f52c48f9801f463f213f0d03e&libraries=services,clusterer"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (function(){
    var KEY = 'theme';
    var btn = document.getElementById('themeToggle');
    if(!btn) return;
    var media = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
    var mode  = localStorage.getItem(KEY) || 'auto';
    function isDarkActive(){
      return mode === 'dark' || (mode === 'auto' && media && media.matches);
    }
    function apply(){
      var dark = isDarkActive();
      document.documentElement.classList.toggle('theme-dark', dark);
      btn.textContent = dark ? '☀️' : '🌙';
      var modeKo = (mode === 'auto' ? '자동(시스템 따라감)' : (mode === 'dark' ? '다크' : '라이트'));
      btn.title = modeKo + ' — 클릭해서 모드 변경';
      btn.setAttribute('aria-label', '테마: ' + modeKo);
    }
    function onSystemChange(){ if(mode === 'auto') apply(); }
    function listenSystem(enable){
      if(!media) return;
      if(enable){
        if(media.addEventListener) media.addEventListener('change', onSystemChange);
        else if(media.addListener) media.addListener(onSystemChange);
      }else{
        if(media.removeEventListener) media.removeEventListener('change', onSystemChange);
        else if(media.removeListener) media.removeListener(onSystemChange);
      }
    }
    apply();
    listenSystem(mode === 'auto');
    btn.addEventListener('click', function(){
      var wasAuto = (mode === 'auto');
      mode = (mode === 'auto') ? 'dark' : (mode === 'dark' ? 'light' : 'auto');
      localStorage.setItem(KEY, mode);
      if(wasAuto && mode !== 'auto') listenSystem(false);
      if(!wasAuto && mode === 'auto') listenSystem(true);
      apply();
    });
  })();

  var DAEJEON_HALL = new kakao.maps.LatLng(36.3504, 127.3845);
  var HOME_LEVEL = 5;
  var map = new kakao.maps.Map(document.getElementById('map'), { center: DAEJEON_HALL, level: HOME_LEVEL });
  var ps = new kakao.maps.services.Places();
  var geocoder = new kakao.maps.services.Geocoder();
  var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
  var markers = [];
  var markerMap = {};
  var statusOverlays = {};
  var merchantStatusCache = {};
  var merchantStatusRequests = {};
  var markerImage = new kakao.maps.MarkerImage('https://raw.githubusercontent.com/AKCU-ryu/OntongDaejeon/main/public/img/ontong_pin.png', new kakao.maps.Size(40, 44), {
    offset: new kakao.maps.Point(20, 44)
  });
  var clusterer = new kakao.maps.MarkerClusterer({
    map: map,
    averageCenter: true,
    minLevel: 6,
    disableClickZoom: false
  });
  var lastPagination = null;
  var kakaoPaginationState = null;

  function placeKey(p){
    return (p.id ? ('id:' + p.id) : (p.place_name || p.title || '')) + '@' + p.x + ',' + p.y;
  }

  function attachStatusOverlay(key, marker){
    var el = document.createElement('div');
    el.className = 'status-overlay';
    var overlay = new kakao.maps.CustomOverlay({
      position: marker.getPosition(),
      content: el,
      yAnchor: 1.4,
      xAnchor: 0.5,
      zIndex: 3
    });
    overlay.setMap(map);
    statusOverlays[key] = { overlay: overlay, el: el };
    kakao.maps.event.addListener(marker, 'position_changed', function(){ overlay.setPosition(marker.getPosition()); });
  }

  function updateStatusVisual(key, status){
    var className = 'status-indicator--pending';
    var title = '확인 중';
    if(status === 'ok'){ className = 'status-indicator--ok'; title = '온통대전 사용 가능'; }
    else if(status === 'none'){ className = 'status-indicator--none'; title = '온통대전 가맹점 아님'; }
    document.querySelectorAll('[data-status-key="' + key.replace(/(["\\])/g,'\\$1') + '"]').forEach(function(el){
      el.classList.remove('status-indicator--pending', 'status-indicator--ok', 'status-indicator--none');
      el.classList.add(className);
      el.setAttribute('title', title);
    });
    var overlayEntry = statusOverlays[key];
    if(overlayEntry){
      overlayEntry.el.classList.remove('status-ok', 'status-none');
      if(status === 'ok') overlayEntry.el.classList.add('status-ok');
      else if(status === 'none') overlayEntry.el.classList.add('status-none');
    }
  }

  function ensureMerchantStatus(poi){
    var key = placeKey(poi);
    if(merchantStatusCache[key] && merchantStatusCache[key] !== 'pending'){
      updateStatusVisual(key, merchantStatusCache[key]);
      return;
    }
    if(merchantStatusRequests[key]) return;
    merchantStatusCache[key] = 'pending';
    updateStatusVisual(key, 'pending');
    var url = new URL(OD_ENDPOINT);
    url.searchParams.set('page', 1);
    url.searchParams.set('perPage', 1);
    url.searchParams.set('returnType', 'JSON');
    url.searchParams.set('serviceKey', API_KEY);
    if(poi.place_name) url.searchParams.set('cond[가맹점::LIKE]', '%' + poi.place_name + '%');
    var addr = poi.road_address_name || poi.address_name;
    if(addr) url.searchParams.set('cond[주소::LIKE]', '%' + addr.split(' ').slice(0, 4).join(' ') + '%');
    if(poi.phone){
      var digits = String(poi.phone).replace(/[^0-9]/g, '');
      if(digits) url.searchParams.set('cond[전화번호::LIKE]', '%' + digits + '%');
    }
    merchantStatusRequests[key] = fetch(url.toString()).then(function(res){
      if(!res.ok) throw new Error('ODcloud HTTP ' + res.status);
      return res.json();
    }).then(function(data){
      var has = data && Array.isArray(data.data) && data.data.length > 0;
      merchantStatusCache[key] = has ? 'ok' : 'none';
      updateStatusVisual(key, merchantStatusCache[key]);
    }).catch(function(err){
      console.warn('온통대전 가맹점 확인 실패', err);
      merchantStatusCache[key] = 'pending';
      updateStatusVisual(key, 'pending');
    }).finally(function(){ delete merchantStatusRequests[key]; });
  }

  function makeMarkerByCoord(poi){
    var pos = new kakao.maps.LatLng(poi.y, poi.x);
    var key = placeKey(poi);
    var marker = new kakao.maps.Marker({ position: pos, image: markerImage });
    kakao.maps.event.addListener(marker, 'click', function(){
      var html = '<div style="padding:6px 8px;max-width:240px;">'
        + '<div style="font-weight:700;margin-bottom:2px;">' + (poi.place_name || poi.title || '장소') + '</div>'
        + (poi.road_address_name ? '<div>' + poi.road_address_name + '</div>' : '')
        + (poi.address_name ? '<div style="color:#6c757d">' + poi.address_name + '</div>' : '')
        + (poi.extra_html || '')
        + '</div>';
      infowindow.setContent(html);
      infowindow.open(map, marker);
    });
    markers.push(marker);
    if(clusterer && clusterer.addMarker){
      clusterer.addMarker(marker);
    }
    markerMap[key] = marker;
    attachStatusOverlay(key, marker);
    ensureMerchantStatus(poi);
    return marker;
  }

  function clearMarkers(){
    if(clusterer){
      if(clusterer.getMarkers && clusterer.removeMarkers){
        var olds = clusterer.getMarkers();
        if(olds && olds.length) clusterer.removeMarkers(olds);
      }else if(clusterer.clear){
        clusterer.clear();
      }
    }
    markers.forEach(function(m){ m.setMap(null); });
    markers = [];
    markerMap = {};
    Object.keys(statusOverlays).forEach(function(k){
      var entry = statusOverlays[k];
      if(entry && entry.overlay) entry.overlay.setMap(null);
    });
    statusOverlays = {};
    infowindow.close();
  }

  function fitBoundsOn(points){
    if(!points.length) return;
    var bounds = new kakao.maps.LatLngBounds();
    points.forEach(function(p){ bounds.extend(p); });
    map.setBounds(bounds);
  }

  function makeMarkerByAddress(address, title, extra_html){
    geocoder.addressSearch(address, function(result, status){
      if(status === kakao.maps.services.Status.OK){
        var poi = { x: result[0].x, y: result[0].y, place_name: title, address_name: address, extra_html: extra_html };
        clearMarkers();
        var marker = makeMarkerByCoord(poi);
        map.setLevel(3);
        map.panTo(marker.getPosition());
        kakao.maps.event.trigger(marker, 'click');
      }
    });
  }

  var categories = [
    { code:'MT1', name:'대형마트' }, { code:'CS2', name:'편의점' },
    { code:'PS3', name:'어린이집·유치원' }, { code:'SC4', name:'학교' },
    { code:'AC5', name:'학원' }, { code:'PK6', name:'주차장' },
    { code:'OL7', name:'주유소·충전소' }, { code:'SW8', name:'지하철역' },
    { code:'BK9', name:'은행' }, { code:'CT1', name:'문화시설' },
    { code:'AG2', name:'중개업소' }, { code:'PO3', name:'공공기관' },
    { code:'AT4', name:'관광명소' }, { code:'AD5', name:'숙박' },
    { code:'FD6', name:'음식점' }, { code:'CE7', name:'카페' },
    { code:'HP8', name:'병원' }, { code:'PM9', name:'약국' }
  ];

  function buildCategoryButtons(){
    var container = document.getElementById('categoryTags');
    if(!container) return;
    container.innerHTML = '';
    categories.forEach(function(cat){
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'category-button';
      btn.textContent = cat.name;
      btn.dataset.code = cat.code;
      btn.addEventListener('click', function(){
        doCategorySearch(cat.code, getSelectedRadius(), cat.name);
        if(!isMobileView()) openPanel();
      });
      container.appendChild(btn);
    });
  }

  var resultsEl = document.getElementById('results');
  var pageInfo = document.getElementById('pageInfo');
  var prevBtn = document.getElementById('prevPage');
  var nextBtn = document.getElementById('nextPage');
  var odPaginationState = null;

  function renderKakaoList(items){
    if(!resultsEl) return;
    resultsEl.innerHTML = '';
    if(!items || !items.length){
      resultsEl.innerHTML = '<li class="result-item"><div class="result-title">검색 결과 없음</div></li>';
      return;
    }
    items.forEach(function(p){
      var key = placeKey(p);
      var storageKey = 'kakao:' + key;
      var li = document.createElement('li');
      li.className = 'result-item';
      li.dataset.key = key;
      li.dataset.x = p.x;
      li.dataset.y = p.y;
      li.dataset.name = p.place_name || '';
      li.dataset.road = p.road_address_name || '';
      li.dataset.addr = p.address_name || '';

      var row = document.createElement('div');
      row.className = 'result-row';

      var titleBox = document.createElement('div');
      titleBox.className = 'result-title';
      var indicator = document.createElement('span');
      indicator.className = 'status-indicator status-indicator--pending';
      indicator.dataset.statusKey = key;
      indicator.title = '확인 중';
      titleBox.appendChild(indicator);
      titleBox.appendChild(document.createTextNode(p.place_name || '장소'));

      var favBtn = document.createElement('button');
      favBtn.type = 'button';
      favBtn.className = 'fav-btn' + (isFav(storageKey) ? ' active' : '');
      favBtn.title = '즐겨찾기';
      favBtn.textContent = '☆';

      favBtn.addEventListener('click', function(ev){
        ev.stopPropagation();
        toggleFav({ key: storageKey, type: 'kakao', title: p.place_name, addr: p.road_address_name || p.address_name, x: p.x, y: p.y });
        favBtn.classList.toggle('active');
      });

      row.appendChild(titleBox);
      row.appendChild(favBtn);
      li.appendChild(row);

      var addr = document.createElement('div');
      addr.className = 'result-addr';
      addr.textContent = p.road_address_name || p.address_name || '';
      li.appendChild(addr);

      var tags = document.createElement('div');
      tags.className = 'result-tags';
      if(p.category_group_code){
        var groupPill = document.createElement('span');
        groupPill.className = 'pill';
        groupPill.textContent = p.category_group_code;
        tags.appendChild(groupPill);
      }
      if(p.phone){
        var phonePill = document.createElement('span');
        phonePill.className = 'pill';
        phonePill.textContent = p.phone;
        tags.appendChild(phonePill);
      }
      if(p.distance){
        var distancePill = document.createElement('span');
        distancePill.className = 'pill';
        distancePill.textContent = p.distance + 'm';
        tags.appendChild(distancePill);
      }
      li.appendChild(tags);

      li.addEventListener('click', function(){
        var m = markerMap[key];
        if(!m){
          m = makeMarkerByCoord({
            x: parseFloat(li.dataset.x),
            y: parseFloat(li.dataset.y),
            place_name: li.dataset.name,
            road_address_name: li.dataset.road,
            address_name: li.dataset.addr
          });
        }
        kakao.maps.event.trigger(m, 'click');
        map.panTo(m.getPosition());
        if(window.matchMedia('(max-width: 920px)').matches) closePanel();
      });

      resultsEl.appendChild(li);
      updateStatusVisual(key, merchantStatusCache[key] || 'pending');
      ensureMerchantStatus(p);
    });
  }

  function updatePager(pagination){
    kakaoPaginationState = pagination || null;
    lastPagination = kakaoPaginationState;
    if(!pagination){
      if(pageInfo) pageInfo.textContent = '';
      if(prevBtn) prevBtn.disabled = true;
      if(nextBtn) nextBtn.disabled = true;
      return;
    }
    if(pageInfo) pageInfo.textContent = pagination.current + ' / ' + pagination.last;
    if(prevBtn) prevBtn.disabled = pagination.current <= 1;
    if(nextBtn) nextBtn.disabled = pagination.current >= pagination.last;
  }

  if(prevBtn) prevBtn.addEventListener('click', function(){ if(lastPagination && lastPagination.gotoPage) lastPagination.gotoPage(lastPagination.current - 1); });
  if(nextBtn) nextBtn.addEventListener('click', function(){ if(lastPagination && lastPagination.gotoPage) lastPagination.gotoPage(lastPagination.current + 1); });

  function renderPlaces(data){
    clearMarkers();
    var points = [];
    data.forEach(function(p){
      var marker = makeMarkerByCoord(p);
      points.push(marker.getPosition());
    });
    if(points.length) fitBoundsOn(points);
    renderKakaoList(data);
  }

  function handlePlacesResponse(data, status, pagination, recentMeta){
    if(status !== kakao.maps.services.Status.OK){
      renderKakaoList([]);
      clearMarkers();
      updatePager(null);
      if(status === kakao.maps.services.Status.ZERO_RESULT){
        alert('검색 결과가 없습니다.');
      }else{
        alert('검색 오류가 발생했습니다.');
      }
      return;
    }
    renderPlaces(data);
    updatePager({
      current: pagination.current,
      last: pagination.last,
      gotoPage: function(page){ pagination.gotoPage(page); }
    });
    if(recentMeta){
      if(recentMeta.type === 'category'){
        pushRecent({ type: 'kakao', mode: 'category', q: recentMeta.label, category: recentMeta.category, radius: recentMeta.radius });
      }else{
        pushRecent({ type: 'kakao', mode: 'keyword', q: recentMeta.label });
      }
    }
  }

  function getSelectedCategory(){
    var el = document.getElementById('cat');
    return el ? el.value : '';
  }

  function getSelectedRadius(){
    var el = document.getElementById('radius');
    return el ? parseInt(el.value, 10) || 2000 : 2000;
  }

  function doKeywordSearch(q){
    if(!q || !q.trim()) return;
    switchTab('kakao');
    var keyword = q.trim();
    ps.keywordSearch(keyword, function(data, status, pagination){
      handlePlacesResponse(data, status, pagination, { type: 'keyword', label: keyword });
    }, { location: map.getCenter() });
  }

  function doCategorySearch(code, radius, label){
    var selected = code || getSelectedCategory();
    var effectiveLabel = label || (categories.find(function(c){ return c.code === selected; }) || {}).name || '카테고리';
    switchTab('kakao');
    if(!selected){
      var input = document.getElementById('q');
      doKeywordSearch(input && input.value ? input.value : '대전 맛집');
      return;
    }
    var dist = parseInt(radius || getSelectedRadius(), 10) || 2000;
    ps.categorySearch(selected, function(data, status, pagination){
      handlePlacesResponse(data, status, pagination, { type: 'category', label: effectiveLabel + ' / ' + dist + 'm', category: selected, radius: dist });
    }, {
      location: map.getCenter(),
      radius: dist,
      sort: kakao.maps.services.SortBy.DISTANCE
    });
  }

  var panel = document.getElementById('panel');
  var layoutEl = document.getElementById('layout');
  var backdrop = document.getElementById('backdrop');
  var toggleBtn = document.getElementById('togglePanel');
  function isMobileView(){ return window.matchMedia && window.matchMedia('(max-width: 920px)').matches; }
  function openPanel(){
    if(panel) panel.classList.add('open');
    if(layoutEl) layoutEl.classList.add('panel-open');
    if(backdrop){
      if(isMobileView()){
        backdrop.hidden = false;
        backdrop.classList.add('show');
      }else{
        backdrop.classList.remove('show');
        backdrop.hidden = true;
      }
    }
    refreshMapCenter();
  }
  function closePanel(){
    if(panel) panel.classList.remove('open');
    if(layoutEl) layoutEl.classList.remove('panel-open');
    if(backdrop){
      backdrop.classList.remove('show');
      if(isMobileView()){
        setTimeout(function(){ backdrop.hidden = true; }, 200);
      }else{
        backdrop.hidden = true;
      }
    }
    refreshMapCenter();
  }
  if(toggleBtn) toggleBtn.addEventListener('click', function(){ panel.classList.contains('open') ? closePanel() : openPanel(); });
  if(backdrop) backdrop.addEventListener('click', closePanel);

  var resizeTimer;
  function refreshMapCenter(){
    var center = map.getCenter();
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function(){
      map.relayout();
      map.setCenter(center);
    }, 120);
  }
  window.addEventListener('resize', refreshMapCenter);

  var tabKakao = document.getElementById('tabKakao');
  var tabOD = document.getElementById('tabOD');
  var headKakao = document.getElementById('headKakao');
  var headOD = document.getElementById('headOD');
  function switchTab(tab){
    if(tab === 'kakao'){
      if(tabKakao) tabKakao.classList.add('active');
      if(tabOD) tabOD.classList.remove('active');
      if(headKakao) headKakao.style.display = 'grid';
      if(headOD) headOD.style.display = 'none';
      updatePager(kakaoPaginationState);
    }else{
      if(tabOD) tabOD.classList.add('active');
      if(tabKakao) tabKakao.classList.remove('active');
      if(headOD) headOD.style.display = 'grid';
      if(headKakao) headKakao.style.display = 'none';
      renderODPager();
    }
  }
  if(tabKakao) tabKakao.addEventListener('click', function(){ switchTab('kakao'); });
  if(tabOD) tabOD.addEventListener('click', function(){ switchTab('od'); });

  var LS_RECENTS = 'ont_recent_v1';
  var LS_FAVS = 'ont_fav_v1';
  var recentListEl = document.getElementById('recentList');
  var favListEl = document.getElementById('favList');

  function getRecents(){ try{ return JSON.parse(localStorage.getItem(LS_RECENTS) || '[]'); }catch(e){ return []; } }
  function setRecents(arr){ localStorage.setItem(LS_RECENTS, JSON.stringify(arr.slice(0,5))); }
  function pushRecent(entry){
    var arr = getRecents().filter(function(e){ return JSON.stringify({ type:e.type, mode:e.mode, q:e.q, category:e.category, radius:e.radius, cond:e.cond }) !== JSON.stringify({ type:entry.type, mode:entry.mode, q:entry.q, category:entry.category, radius:entry.radius, cond:entry.cond }); });
    arr.unshift({
      type: entry.type,
      mode: entry.mode,
      q: entry.q,
      category: entry.category,
      radius: entry.radius,
      cond: entry.cond ? { name: entry.cond.name || '', addr: entry.cond.addr || '', gu: entry.cond.gu || '', dong: entry.cond.dong || '' } : undefined,
      ts: Date.now()
    });
    setRecents(arr);
    renderRecents();
  }
  function getFavs(){ try{ return JSON.parse(localStorage.getItem(LS_FAVS) || '[]'); }catch(e){ return []; } }
  function setFavs(arr){ localStorage.setItem(LS_FAVS, JSON.stringify(arr.slice(0,100))); }
  function isFav(key){ return getFavs().some(function(f){ return f.key === key; }); }
  function toggleFav(item){
    var favs = getFavs();
    var idx = favs.findIndex(function(f){ return f.key === item.key; });
    if(idx >= 0) favs.splice(idx,1); else favs.unshift(item);
    setFavs(favs);
    renderFavs();
  }
  function renderRecents(){
    if(!recentListEl) return;
    var arr = getRecents();
    if(!arr.length){
      recentListEl.innerHTML = '<li class="recent-empty">최근 검색 없음</li>';
      return;
    }
    recentListEl.innerHTML = '';
    arr.slice(0,5).forEach(function(e){
      var li = document.createElement('li');
      li.className = 'recent-item';

      var row = document.createElement('div');
      row.className = 'recent-row';

      var tag = document.createElement('span');
      tag.className = 'recent-tag';
      tag.textContent = e.type === 'kakao' ? (e.mode === 'category' ? '카테고리' : '키워드') : '가맹점';

      var text = document.createElement('div');
      text.className = 'recent-text';
      var content = '';
      if(e.type === 'kakao'){
        if(e.mode === 'category'){
          content = e.q || '카카오 카테고리 검색';
        }else{
          content = e.q || '카카오 검색';
        }
      }else{
        var c = e.cond || {};
        content = [c.name, c.addr, c.gu, c.dong].filter(Boolean).join(' · ') || '가맹점 검색';
      }
      text.textContent = content;
      text.dataset.expanded = 'false';

      var rerun = document.createElement('button');
      rerun.type = 'button';
      rerun.className = 'recent-rerun';
      rerun.textContent = '↻';
      rerun.title = '다시 검색';

      rerun.addEventListener('click', function(){
        if(e.type === 'kakao'){
          if(e.mode === 'category'){
            doCategorySearch(e.category, e.radius, e.q);
          }else{
            doKeywordSearch(e.q);
          }
        }else{
          doODSearch(e.cond || {}, 1);
        }
      });

      row.appendChild(tag);
      row.appendChild(text);
      row.appendChild(rerun);
      li.appendChild(row);

      var more = document.createElement('button');
      more.type = 'button';
      more.className = 'recent-more';
      more.textContent = '더보기';
      more.hidden = true;
      more.addEventListener('click', function(){
        var expanded = text.dataset.expanded === 'true';
        text.dataset.expanded = expanded ? 'false' : 'true';
        more.textContent = expanded ? '더보기' : '접기';
      });

      li.appendChild(more);
      recentListEl.appendChild(li);

      requestAnimationFrame(function(){
        if(text.scrollHeight > text.clientHeight + 2){
          more.hidden = false;
        }
      });
    });
  }
  function renderFavs(){
    if(!favListEl) return;
    var favs = getFavs();
    favListEl.innerHTML = '';
    if(!favs.length){
      favListEl.innerHTML = '<li style="font-size:12px;color:var(--muted);">즐겨찾기 없음</li>';
      return;
    }
    favs.forEach(function(f){
      var li = document.createElement('li');
      li.className = 'result-item';
      li.innerHTML =
        '<div class="result-row">'
        + '<div class="result-title">' + (f.title || '항목') + '</div>'
        + '<button class="fav-btn active" title="즐겨찾기 해제">⭐</button>'
        + '</div>'
        + '<div class="result-addr">' + (f.addr || '') + '</div>'
        + '<div class="result-tags"><span class="pill">' + (f.type || '').toUpperCase() + '</span></div>';
      li.querySelector('.fav-btn').addEventListener('click', function(ev){
        ev.stopPropagation();
        toggleFav(f);
      });
      li.addEventListener('click', function(ev){
        if(ev.target.classList.contains('fav-btn')) return;
        if(f.x && f.y){
          clearMarkers();
          var marker = makeMarkerByCoord({ x: f.x, y: f.y, place_name: f.title, address_name: f.addr });
          map.setLevel(3);
          map.panTo(marker.getPosition());
          kakao.maps.event.trigger(marker, 'click');
        }else if(f.addr){
          makeMarkerByAddress(f.addr, f.title);
        }
      });
      favListEl.appendChild(li);
    });
  }
  var btnClearRecents = document.getElementById('btnClearRecents');
  var btnClearFavs = document.getElementById('btnClearFavs');
  if(btnClearRecents) btnClearRecents.addEventListener('click', function(){ localStorage.removeItem(LS_RECENTS); renderRecents(); });
  if(btnClearFavs) btnClearFavs.addEventListener('click', function(){ localStorage.removeItem(LS_FAVS); renderFavs(); });
  renderRecents();
  renderFavs();
  buildCategoryButtons();

  var searchBtn = document.getElementById('searchBtn');
  if(searchBtn){
    function triggerRipple(btn){
      btn.classList.remove('ripple');
      requestAnimationFrame(function(){ btn.classList.add('ripple'); });
    }
    searchBtn.addEventListener('click', function(e){
      e.preventDefault();
      triggerRipple(searchBtn);
      doKeywordSearch(document.getElementById('q') ? document.getElementById('q').value : '');
    });
  }
  var qInput = document.getElementById('q');
  if(qInput){
    qInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        doKeywordSearch(e.target.value);
      }
    });
  }

  var catSelect = document.getElementById('cat');
  var radiusSelect = document.getElementById('radius');
  function handleCategoryChange(){
    doCategorySearch(catSelect ? catSelect.value : '', radiusSelect ? radiusSelect.value : undefined);
  }
  if(catSelect) catSelect.addEventListener('change', handleCategoryChange);
  if(radiusSelect) radiusSelect.addEventListener('change', handleCategoryChange);

  const CSV_URLS = {
    applied: 'https://raw.githubusercontent.com/AKCU-ryu/OntongDaejeon/main/대전광역시_온통대전%20신청%20가맹점%20목록_20211130.csv',
    monthly: 'https://raw.githubusercontent.com/AKCU-ryu/OntongDaejeon/main/대전광역시_온통대전%20월별%20업종별%20가맹점%20수_20210930.csv'
  };
 
  let appliedData = [];
  let monthlyData = [];
  async function loadCsv(url){
    const res = await fetch(url);
    const csvText = await res.text();
    const parsed = Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true
    });
    return parsed.data;
  }
  
  // 🚀 두 파일 병렬 로드
  async function init(){
    try{
      const [applied, monthly] = await Promise.all([
        loadCsv(CSV_URLS.applied),
        loadCsv(CSV_URLS.monthly)
      ]);

      appliedData = applied;
      monthlyData = monthly;

      console.log('✅ 신청 가맹점', appliedData.length);
      console.log('✅ 월별 업종별', monthlyData.length);

      renderAppliedTable();
      renderMonthlyChart();
    }catch(err){
      console.error('CSV 로드 실패:', err);
    }
  }
  function renderAppliedTable(){
    // 신청 가맹점 데이터를 테이블이나 지도에 표시
    console.log(appliedData.slice(0,5));
  }
  function renderMonthlyChart(){
    // 월별 업종별 데이터를 차트로 그리기
    console.log(monthlyData.slice(0,5));
  }
  // 시작
  init();

  var OD_ENDPOINT = 'https://api.odcloud.kr/api/15097203/v1/uddi:fc30c6ac-23a9-4d0b-95dd-f0e4f2ef3115';
  var API_KEY = 'QpWPp9txkmGnVhhlXoHPY8ifB9x/4qxyqYeCH7jFzB82up9cr2dCbJI7veH8NjbhVOzcBFRTKDMgpWQmA/bf2A==';
  var odPerPage = 20;
  var odPage = 1;
  var odTotal = 0;
  var odInputs = {
    name: document.getElementById('odName'),
    addr: document.getElementById('odAddr'),
    gu: document.getElementById('odGu'),
    dong: document.getElementById('odDong')
  };

  function odCondParams(cond){
    var params = {};
    if(cond.name) params['cond[가맹점::LIKE]'] = '%' + cond.name + '%';
    if(cond.addr) params['cond[주소::LIKE]'] = '%' + cond.addr + '%';
    if(cond.gu) params['cond[구::EQ]'] = cond.gu;
    if(cond.dong) params['cond[동::EQ]'] = cond.dong;
    return params;
  }

  function fetchOD(cond, page){
    var url = new URL(OD_ENDPOINT);
    url.searchParams.set('page', page);
    url.searchParams.set('perPage', odPerPage);
    url.searchParams.set('returnType', 'JSON');
    url.searchParams.set('serviceKey', API_KEY);
    var extra = odCondParams(cond);
    Object.keys(extra).forEach(function(k){ url.searchParams.set(k, extra[k]); });
    return fetch(url.toString()).then(function(res){
      if(!res.ok) throw new Error('ODcloud HTTP ' + res.status);
      return res.json();
    });
  }

  function renderODList(rows){
    if(!resultsEl) return;
    resultsEl.innerHTML = '';
    if(!rows || !rows.length){
      resultsEl.innerHTML = '<li class="result-item"><div class="result-title">검색 결과 없음</div></li>';
      return;
    }
    rows.forEach(function(r){
      var title = r['가맹점'] || '가맹점';
      var addr = r['주소'] || '';
      var gu = r['구'] || '';
      var dong = r['동'] || '';
      var key = 'od:' + title + ':' + addr;
      var li = document.createElement('li');
      li.className = 'result-item';
      li.innerHTML =
        '<div class="result-row">'
        + '<div class="result-title">' + title + '</div>'
        + '<button class="fav-btn' + (isFav(key) ? ' active' : '') + '" title="즐겨찾기">⭐</button>'
        + '</div>'
        + '<div class="result-addr">' + addr + '</div>'
        + '<div class="result-tags">'
        + (gu ? '<span class="pill">' + gu + '</span>' : '')
        + (dong ? '<span class="pill">' + dong + '</span>' : '')
        + '</div>';
      li.querySelector('.fav-btn').addEventListener('click', function(ev){
        ev.stopPropagation();
        toggleFav({ key:key, type:'od', title:title, addr:addr });
        this.classList.toggle('active');
      });
      li.addEventListener('click', function(){
        switchTab('kakao');
        makeMarkerByAddress(addr, title, '<div style="margin-top:4px;color:#6c757d">' + (gu + ' ' + dong).trim() + '</div>');
      });
      resultsEl.appendChild(li);
    });
  }

  function updateODPager(total, pageNow){
    odTotal = total;
    odPage = pageNow;
    var last = total > 0 ? Math.ceil(total / odPerPage) : pageNow;
    odPaginationState = {
      type: 'od',
      current: pageNow,
      last: last,
      total: total,
      gotoPage: function(n){ doODSearch(readODCond(), n); }
    };
    renderODPager();
  }

  function renderODPager(){
    if(!odPaginationState){
      if(pageInfo) pageInfo.textContent = '';
      if(prevBtn) prevBtn.disabled = true;
      if(nextBtn) nextBtn.disabled = true;
      lastPagination = null;
      return;
    }
    if(pageInfo) pageInfo.textContent = odPaginationState.current + ' / ' + odPaginationState.last + ' (총 ' + odPaginationState.total.toLocaleString() + '건)';
    if(prevBtn) prevBtn.disabled = odPaginationState.current <= 1;
    if(nextBtn) nextBtn.disabled = odPaginationState.current >= odPaginationState.last;
    lastPagination = odPaginationState;
  }

  function readODCond(){
    return {
      name: odInputs.name ? odInputs.name.value.trim() : '',
      addr: odInputs.addr ? odInputs.addr.value.trim() : '',
      gu: odInputs.gu ? odInputs.gu.value.trim() : '',
      dong: odInputs.dong ? odInputs.dong.value.trim() : ''
    };
  }

  function doODSearch(cond, page){
    switchTab('od');
    var targetPage = page || 1;
    fetchOD(cond, targetPage).then(function(data){
      var rows = (data && data.data) ? data.data : [];
      var total = (data && typeof data.totalCount === 'number') ? data.totalCount : rows.length;
      renderODList(rows);
      updateODPager(total, targetPage);
      pushRecent({ type:'od', cond: cond });
    }).catch(function(err){
      console.error(err);
      alert('ODcloud 조회 오류: ' + err.message);
      renderODList([]);
      updateODPager(0, 1);
    });
  }

  var btnODSearch = document.getElementById('btnODSearch');
  var btnODReset = document.getElementById('btnODReset');
  if(btnODSearch) btnODSearch.addEventListener('click', function(){ doODSearch(readODCond(), 1); });
  if(btnODReset) btnODReset.addEventListener('click', function(){
    Object.keys(odInputs).forEach(function(k){ if(odInputs[k]) odInputs[k].value = ''; });
    doODSearch({}, 1);
  });

  function goHome(){
    map.setLevel(HOME_LEVEL);
    map.setCenter(DAEJEON_HALL);
    clearMarkers();
    infowindow.close();
  }
  var logoIcon = document.getElementById('logoIcon');
  var logoText = document.getElementById('logoText');
  if(logoIcon) logoIcon.addEventListener('click', goHome);
  if(logoText) logoText.addEventListener('click', goHome);

  window.addEventListener('load', function(){
    switchTab('kakao');
    doCategorySearch('CE7', 2000, '카페');
  });
  </script>
</body>
</html>